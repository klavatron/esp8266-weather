# esp8266-weather
Мониторинговая станция для narodmon.ru на базе ESP8266

Базовый скетч для создания мониторинговой метеостанции с использованием модулей esp8266-201, esp8866-12f или LoLin NodeMCU module. Собирает показания с сенсоров и отправляет на narodmon.ru через POST-запрос.

## Поддерживаемые датчики

* i2c bmp075 датчик давления
* i2c bh1750 датчик освещенности
* i2c HTU21 датчик влажности (address 0x40)
* i2c CCS811 датчик eCO2, TVOC (летучие органические вещества)
* onewire ds18b20 термометры
* аналоговый датчик
* dht11 датчик влажности
* sht1x датчик влажности

* Аналоговый мультиплексор hc4051, для подключения нескольких аналоговых датчиков (например, ёмкостных датчиков влажности грунта).

## Прочее

* Возможность использования режима глубокого сна, для повышения энергоэффективности
* Возможность отключать питание сенсоров в режиме глубокого сна, используя мосфет
* Возможность подключить i2c oled дисплей (надо допилить)
* Возможность использовать светодиодный индикатор
* Возможность обновлять прошивку по wifi (OTA). Для входа в режим используется кнопка. Без шифрования. На плате ESP-201 может не работать.
* Возможность вывода отладочной информации в серийный монитор

## Настройка

Практически все сенсоры подключаются по i2c. Распиновка находится в файле __pins.h__. Для увеличения срока службы датчиков, можно отключать их от питания, когда станция переходит в режим глубокого сна. Для этого можно ставить управляемый мосфет в разрыв земли датчиков. 

При использовании wifi, скопировать файл настроек __wifi.cfg.h.example__ в __wifi.cfg.h__. Ввести свои настройки:
> 
Файл wifi.cfg.h внесён в gitignore, в нём не отслеживаются изменения.
* __ssid__ и __password__ - имя и пароль точки доступа к которой подключается станция.
* __update_username__ и __update_password__ - логин и пароль для доступа к странице обновлений по wifi. 
* ap_ssid и avgadmin - имя и пароль точки доступа, которая будет создана, если не удаётся подключится к прописаной выше
* Скопировать __narodmon.cfg.h.example__ в __narodmon.cfg.h__. Придумать случайный мак-адрес своему устройству в проэкте narodmon и записать его в переменную __"narodmonDevId"__. 

> Файл narodmon.cfg.h внесён в gitignore, в нём не отслеживаются изменения.

В файле __defines.h__ в блоке с __#define__ указать нужные датчики и режимы


## Плата NodeMCU
![alt text](https://github.com/klavatron/esp8266-weather/blob/master/pcbs/breadboard/weather-st2.jpg)

### Простейшее подключение датчиков влажности, освещенности и барометра с термометром:

#### Что нужно:
- Быть зарегистрированным на сайте narodmon
- Esp8266 esp-12e LoLin NodeMCU
- макетная плата
- bmp180 - модуль барометра с термометром
- BH1750 - модуль измерения освещенности
- HTU21 - модуль измерения влажности (значительно лучше чем DHT11)
- Провода витой пары, для подключения модулей к ESP8266

#### Подключение:
Перед тем как воткнуть ESP8266 в макетную плату, подключить проводами линии питания макетной платы к линиям в которые будет подключено 3,3в и gnd от nodemcu (лучше выбирать gnd который не находится рядом с 5в). Аналогично вывести провода для i2c (scl сенсора в D6 nodemcu, sda - D5). Воткнуть nodemcu. Убедиться, что питание подаётся на макетную плату.

На оставшемся месте расположить модули. Подать на модули питание и линии scl, sda.

- В файле wifi.cfg.h прописать настройки точки доступа
- В файле narodmon.cfg.h прописать свой выдуманный мак-адрес
- В файле defines.h установить
  - DEBUG 1      для вывода отладочной информации в серийный монитор
  - USE_SLEEP_MODE 1     для перехода в спящий режим на 10 минут
  - WIFI 1       для включения wifi
  - NARODMON 1   для отправки данных на сайт narodmon
  - BMP_EXIST 1      для получения показаний давления и температуры
  - BH1750_EXIST 1   для получения показаний датчика освещенности
  - HTU21_EXIST 1    для получения показаний датчика влажности


## Другие варианты 

### Esp8266-201 на макетной плате:
![alt text](https://github.com/klavatron/esp8266-weather/blob/master/pcbs/breadboard/weather-st.png)

- Esp8266-201
- макетная плата
- bmp180 - модуль барометра с термометром
- dth11 - низкокачественный датчик влажности и термометр
- ds18b20 - термометр
- резисторы для dht и ds18b20
- 3.3v источник питания
- провода


### Esp8266-201 на плате изготовленной методом ЛУТ:
![alt text](https://github.com/klavatron/esp8266-weather/blob/master/pcbs/esp201/1.jpg)

- Esp8266-201
- подготовленная плата с распаянными резисторами, конденсаторами, стабилизатором питания 7333
- bmp180 - модуль барометра с термометром
- BH1750 - модуль измерения освещенности
- HTU21 - модуль измерения влажности (значительно лучше чем DHT11)
- ds18b20 - термометры


### Esp8266-12 с мультиплексором для подключения нескольких датчиков влажности грунта:
![alt text](https://github.com/klavatron/esp8266-weather/blob/master/pcbs/esp8266-12f-analog_multiplexer/1.jpg)

- Esp8266-12F
- подготовленная плата с распаянными резисторами, конденсаторами, стабилизатором питания 7333
- 7 ёмкостных датчиков влажности грунта
- dth11 - датчик влажности и термометр
